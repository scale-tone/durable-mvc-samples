(this["webpackJsonpappointments-sample-ui"]=this["webpackJsonpappointments-sample-ui"]||[]).push([[0],{82:function(t,e,n){},93:function(t,e,n){"use strict";n.r(e);var i,a=n(0),s=n.n(a),o=n(13),r=n.n(o),c=(n(82),n(17)),l=n(18),u=n(47),y=n(46),d=n(7),h=n(66),f=n(123),g=n(126),p=n(134),m=n(136),v=n(128),S=n(130),E=n(131),b=n(127),j=n(132),O=n(94),C=n(133),w=n(137),I=n(129),k=n(67),N=n(16),x=n(48),P=function(){function t(){Object(c.a)(this,t),this.entityName="",this.entityKey="",this.version=0,this.stateDiff=[],this.isEntityDestructed=!1}return Object(l.a)(t,null,[{key:"GetEntityId",value:function(e){return t.FormatEntityId(e.entityName,e.entityKey)}},{key:"FormatEntityId",value:function(t,e){return"@".concat(t,"@").concat(e)}}]),t}(),A=function(){function t(){Object(c.a)(this,t),this.version=0,this.state={}}return Object(l.a)(t,null,[{key:"GetEntityNameAndKey",value:function(t){var e=/@([^@]+)@(.+)/.exec(t);return{entityNameLowerCase:e?e[1]:"",entityKey:e?e[2]:""}}}]),t}(),R=n(49),K=n(23),D="/a/p/i",L=function(t){Object(u.a)(n,t);var e=Object(y.a)(n);function n(t){var i;return Object(c.a)(this,n),(i=e.call(this,N.d.instance))._configFabric=t,i}return Object(l.a)(n,[{key:"send",value:function(t){var e=this;if(t.url.includes(D)){var i=this._configFabric();if(i.accessTokenFactory)return i.accessTokenFactory().then((function(i){return t.headers={},t.headers.Authorization="Bearer "+i,Object(R.a)(Object(K.a)(n.prototype),"send",e).call(e,t)}));if(i.fakeUserNamePromise)return i.fakeUserNamePromise.then((function(i){return i&&(t.headers={},t.headers["x-ms-client-principal-name"]=i),Object(R.a)(Object(K.a)(n.prototype),"send",e).call(e,t)}))}return Object(R.a)(Object(K.a)(n.prototype),"send",this).call(this,t)}}]),n}(N.a),T=function(){function t(e){Object(c.a)(this,t),this._maxKnownEntityIdsToPersist=e,this.States={},this.LocalStorageKnownIdsKey="DurableEntitySetKnownEntityIds"}return Object(l.a)(t,[{key:"getState",value:function(t){return this.States[t]}},{key:"getStatesCopy",value:function(){return Object.assign({},this.States)}},{key:"addOrUpdateState",value:function(t,e){if(this.States[t]=e,localStorage){var n=Object.keys(this.States).slice(0,this._maxKnownEntityIdsToPersist());localStorage.setItem(this.LocalStorageKnownIdsKey,JSON.stringify(n))}}},{key:"removeState",value:function(t){if(delete this.States[t],localStorage){var e=Object.keys(this.States).slice(0,this._maxKnownEntityIdsToPersist());localStorage.setItem(this.LocalStorageKnownIdsKey,JSON.stringify(e))}}},{key:"getStoredEntityIds",value:function(t){if(!localStorage)return[];var e=localStorage.getItem(this.LocalStorageKnownIdsKey);return e?JSON.parse(e).filter((function(e){return A.GetEntityNameAndKey(e).entityNameLowerCase===t})):[]}},{key:"removeStoredEntityIds",value:function(t){localStorage&&localStorage.removeItem(this.LocalStorageKnownIdsKey)}}]),t}(),F=function(){function t(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Object(c.a)(this,t),this.items=[],this._entityNameLowerCase=void 0,this._entityNameLowerCase=e.toLowerCase(),Object(d.m)(this,{items:d.n}),n&&this.attachAllEntities()}return Object(l.a)(t,[{key:"attachAllEntities",value:function(){var e=this;return t.initSignalR(),t.EntitySets[this._entityNameLowerCase]=this.items,t.fetchAndApplyKnownEntityStates(this._entityNameLowerCase).then((function(){return t.fetchAndApplyAllEntityStates(e._entityNameLowerCase)}))}},{key:"attachEntity",value:function(e){var n=P.FormatEntityId(this._entityNameLowerCase,e);t.EntityStates.getState(n)||(t.EntitySets[n]=this.items,t.attachEntity(this._entityNameLowerCase,e,void 0))}},{key:"createEntity",value:function(e){t.createEntity(this._entityNameLowerCase,e,void 0)}},{key:"signalEntity",value:function(e,n,i){return t.signalEntity(this._entityNameLowerCase,e,n,i)}},{key:"callEntity",value:function(e,n,i){return t.callEntity(this._entityNameLowerCase,e,n,i)}},{key:"updateEntityMetadata",value:function(e,n){return t.updateEntityMetadata(this._entityNameLowerCase,e,n)}}],[{key:"attachEntity",value:function(e,n,i){t.initSignalR();var a=e.toLowerCase(),s=this.EntityStates.getState(P.FormatEntityId(a,n));return s?s.state:(i&&Object(d.l)(i),this.fetchAndApplyEntityState(a,n,0,0,i),i)}},{key:"createEntity",value:function(t,e,n){return this.updateEntityMetadata(t,e,{}),this.attachEntity(t,e,n)}},{key:"signalEntity",value:function(t,e,n,i){var a=t.toLowerCase(),s="".concat(D,"/entities/").concat(encodeURI(a),"/").concat(encodeURI(e),"/").concat(encodeURI(n));return this.HttpClient.post(s,{content:JSON.stringify(i)}).then()}},{key:"callEntity",value:function(t,e,n,i){var a=this,s=t.toLowerCase(),o="".concat(D,"/entities/").concat(encodeURI(s),"/").concat(encodeURI(e),"/").concat(encodeURI(n));return new Promise((function(t,e){a.HttpClient.post(o,{content:JSON.stringify(i)}).then((function(n){var i=JSON.parse(n.content).correlationId;a.SignalResultPromises[i]={resolve:t,reject:e}}),e)}))}},{key:"updateEntityMetadata",value:function(t,e,n){return this.signalEntity(t,e,"$update-entity-internal-metadata",n)}},{key:"setup",value:function(t){this.Config=t,this.Config.logger||(this.Config.logger=N.d.instance)}},{key:"entityAdded",value:function(t,e,n){var i=P.FormatEntityId(t,e),a=this.EntitySets[i];a?delete this.EntitySets[i]:a=this.EntitySets[t],a&&(n.entityKey=e,a.push(n))}},{key:"entityDeleted",value:function(t,e){var n=this.EntitySets[t];if(n)for(var i=0;i<n.length;i++)if(n[i].entityKey===e){n.splice(i,1);break}}},{key:"fetchAndApplyEntityState",value:function(t,e,n,i){var a=this,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o="".concat(D,"/entities/").concat(encodeURI(t),"/").concat(encodeURI(e));this.HttpClient.get(o).then((function(i){var o=JSON.parse(i.content),r=P.FormatEntityId(t,e);if(n&&o.version<n)throw new Error("Expected ".concat(r," of version ").concat(n,", but got version ").concat(o.version));s?a.applyStateChangesFrom(s,o.state):(s=o.state,Object(d.l)(s)),a.EntityStates.getState(r)||a.entityAdded(t,e,s),a.EntityStates.addOrUpdateState(r,{state:s,version:o.version})})).catch((function(o){i<a.MaxRetryCount?(i++,setTimeout((function(){a.fetchAndApplyEntityState(t,e,n,i,s)}),i*a.RetryBaseIntervalMs)):a.Config.logger.log(N.c.Error,"DurableEntitySet: failed to fetch entity state: ".concat(o))}))}},{key:"fetchAndApplyAllEntityStates",value:function(t){var e=this,n=this.EntityStates.getStatesCopy(),i="".concat(D,"/entities/").concat(encodeURI(t));return this.HttpClient.get(i).then((function(i){var a,s=Object(k.a)(JSON.parse(i.content));try{for(s.s();!(a=s.n()).done;){var o=a.value,r=o.entityKey,c=P.FormatEntityId(t,r),l=o,u=n[c];delete n[c],u?u.version<l.version?(e.Config.logger.log(N.c.Information,"DurableEntitySet: ".concat(c,", local version ").concat(u.version,", remote version ").concat(l.version,". State was updated.")),e.applyStateChangesFrom(u.state,l.state),u.version=l.version):e.Config.logger.log(N.c.Information,"DurableEntitySet: ".concat(c," is already known and is up to date. Skipping.")):(Object(d.l)(l.state),e.EntityStates.addOrUpdateState(c,l),e.entityAdded(t,r,l.state))}}catch(f){s.e(f)}finally{s.f()}for(var y in n){e.EntityStates.removeState(y);var h=A.GetEntityNameAndKey(y);e.entityDeleted(h.entityNameLowerCase,h.entityKey)}})).catch((function(t){e.Config.logger.log(N.c.Error,"DurableEntitySet: failed to fetch entity states: ".concat(t))}))}},{key:"fetchAndApplyKnownEntityStates",value:function(t){var e=this,n=this.EntityStates.getStoredEntityIds(t),i=this.EntityStates.getStatesCopy(),a="".concat(D,"/entities");return this.HttpClient.post(a,{content:JSON.stringify(n)}).then((function(t){for(var a=JSON.parse(t.content),s=0;s<n.length;s++){var o=n[s],r=A.GetEntityNameAndKey(o),c=a[s],l=i[o];l?l.version<c.version?(e.Config.logger.log(N.c.Information,"DurableEntitySet: ".concat(o,", local version ").concat(l.version,", remote version ").concat(c.version,". State was updated.")),e.applyStateChangesFrom(l.state,c.state),l.version=c.version):e.Config.logger.log(N.c.Information,"DurableEntitySet: ".concat(o," is already known and is up to date. Skipping.")):(Object(d.l)(c.state),e.EntityStates.addOrUpdateState(o,c),e.entityAdded(r.entityNameLowerCase,r.entityKey,c.state))}})).catch((function(n){e.Config.logger.log(N.c.Warning,"DurableEntitySet: failed to fetch known entity states: ".concat(n)),e.EntityStates.removeStoredEntityIds(t)}))}},{key:"entityStateChangedMessageHandler",value:function(t){var e=this,n=P.GetEntityId(t);this.Config.logger.log(N.c.Trace,"DurableEntitySet: ".concat(n," changed to version ").concat(t.version));var i=this.EntityStates.getState(n);if(t.isEntityDestructed)this.EntityStates.removeState(n),this.entityDeleted(t.entityName,t.entityKey);else if(i){var a=i.version+1;t.version>a?this.fetchAndApplyEntityState(t.entityName,t.entityKey,t.version,0,i.state):t.version===a&&(x.applyPatch(i.state,t.stateDiff),i.version=t.version)}else(this.EntitySets[n]||this.EntitySets[t.entityName])&&setTimeout((function(){return e.fetchAndApplyEntityState(t.entityName,t.entityKey,t.version,0)}),this.RetryBaseIntervalMs)}},{key:"entitySignalResponseHandler",value:function(t){var e=this.SignalResultPromises[t.correlationId];e&&(t.errorMessage?e.reject(new Error(t.errorMessage)):e.resolve(t.result),delete this.SignalResultPromises[t.correlationId])}},{key:"initSignalR",value:function(){var t=this;this.SignalRConn||(this.SignalRConn=(new N.b).withUrl("".concat(D),{httpClient:this.HttpClient,logger:this.Config.logger}).build(),this.SignalRConn.on("entity-state-changed",(function(e){return t.entityStateChangedMessageHandler(e)})),this.SignalRConn.on("entity-signal-response",(function(e){return t.entitySignalResponseHandler(e)})),this.SignalRConn.onclose((function(){return t.reconnectToSignalR()})),this.SignalRConn.start().then((function(){t.Config.logger.log(N.c.Information,"DurableEntitySet: successfully connected to SignalR")}),(function(e){t.Config.logger.log(N.c.Error,"DurableEntitySet: failed to connect to SignalR: ".concat(e))})))}},{key:"reconnectToSignalR",value:function(){var t=this;this.Config.logger.log(N.c.Information,"DurableEntitySet: reconnecting to SignalR..."),this.SignalRConn.start().then((function(){t.Config.logger.log(N.c.Information,"DurableEntitySet: reconnected to SignalR")}),(function(){setTimeout((function(){return t.reconnectToSignalR()}),t.SignalRReconnectIntervalInMs)}))}},{key:"applyStateChangesFrom",value:function(t,e){e.entityKey=t.entityKey;var n=x.createPatch(t,e);x.applyPatch(t,n)}}]),t}();F.Config={logger:N.d.instance},F.HttpClient=new L((function(){return F.Config})),F.EntitySets={},F.SignalResultPromises={},F.SignalRConn=void 0,F.SignalRReconnectIntervalInMs=5e3,F.MaxRetryCount=6,F.RetryBaseIntervalMs=500,F.DefaultMaxKnownEntityIdsToPersist=100,F.EntityStates=new T((function(){return void 0===F.Config.maxKnownEntityIdsToPersist?F.DefaultMaxKnownEntityIdsToPersist:F.Config.maxKnownEntityIdsToPersist})),function(t){t[t.Pending=0]="Pending",t[t.Accepted=1]="Accepted",t[t.Declined=2]="Declined"}(i||(i={}));var M=n(9);F.setup({logger:{log:function(t,e){return console.log(e)}},fakeUserNamePromise:new Promise((function(t){fetch("/.auth/me").then((function(t){return t.json()})).then((function(e){if(!e||!e.length)throw new Error("EasyAuth seems to be not configured. Falling back to a fake user name");U.userName=e[0].user_id,t(null)})).catch((function(){U.userName=prompt("Enter your name:","Anonymous"),t(U.userName)}))}))});var U=Object(d.l)({userName:"",participantsText:"",inProgress:!0,appointments:new F("AppointmentEntity",!1)});U.appointments.attachAllEntities().finally((function(){U.inProgress=!1}));var _=Object(h.a)(function(t){Object(u.a)(n,t);var e=Object(y.a)(n);function n(){return Object(c.a)(this,n),e.apply(this,arguments)}return Object(l.a)(n,[{key:"createNewAppointment",value:function(){var t=U.participantsText.split(",").map((function(t){return t.trim()})).filter((function(t){return!!t})),e="APP-"+(new Date).toISOString();U.inProgress=!0,U.appointments.callEntity(e,"init",t).catch((function(t){return alert(t.message)})).finally((function(){U.inProgress=!1})),U.participantsText=""}},{key:"render",value:function(){var t=this;return Object(M.jsxs)(M.Fragment,{children:[Object(M.jsx)(f.a,{position:"static",color:"default",className:"app-bar",children:Object(M.jsxs)(g.a,{children:[Object(M.jsx)(p.a,{fullWidth:!0,label:"Comma-separated list of participants (or empty string to create appointment with yourself)",placeholder:"Alice, Bob, Charlie...",InputLabelProps:{shrink:!0},variant:"outlined",size:"small",value:U.participantsText,disabled:U.inProgress,onChange:function(t){return U.participantsText=t.target.value},onKeyPress:function(e){"Enter"===e.key&&(e.preventDefault(),t.createNewAppointment())}}),Object(M.jsx)(m.a,{width:20}),Object(M.jsx)(v.a,{variant:"contained",color:"default",size:"large",className:"new-appointment-button",disabled:U.inProgress,onClick:function(){return t.createNewAppointment()},children:"Create new appointment"}),Object(M.jsx)(m.a,{width:40}),Object(M.jsx)(I.a,{}),Object(M.jsx)(m.a,{width:5}),Object(M.jsx)(S.a,{children:U.userName})]})}),U.inProgress?Object(M.jsx)(E.a,{}):Object(M.jsx)(m.a,{height:4}),Object(M.jsxs)(b.a,{children:[0===U.appointments.items.length&&Object(M.jsx)(S.a,{variant:"h5",className:"empty-list-placeholder",children:"No appointments created yet"}),U.appointments.items.map((function(t){return Object(M.jsx)(j.a,{children:Object(M.jsx)(O.a,{className:"appointment-paper",children:Object(M.jsxs)(C.a,{container:!0,spacing:2,children:[Object(M.jsxs)(C.a,{item:!0,xs:2,children:[t.status===i.Pending&&Object(M.jsx)(w.a,{label:"Pending",color:"default",variant:"outlined",className:"appointment-status-chip"}),t.status===i.Accepted&&Object(M.jsx)(w.a,{label:"Everybody accepted",color:"primary",variant:"outlined",className:"appointment-status-chip"}),t.status===i.Declined&&Object(M.jsx)(w.a,{label:"Someone declined",color:"secondary",variant:"outlined",className:"appointment-status-chip"})]}),Object(M.jsx)(C.a,{item:!0,xs:2,children:Object(M.jsx)(S.a,{className:"participants-text",children:"Participants:"})}),Object(M.jsx)(C.a,{item:!0,xs:5,className:"appointment-grid-cell",children:Object.keys(t.participants).map((function(e){return Object(M.jsx)(w.a,{label:e,color:t.participants[e]===i.Accepted?"primary":t.participants[e]===i.Declined?"secondary":"default",className:"participant-chip"})}))}),Object(M.jsx)(C.a,{item:!0,xs:1,children:Object(M.jsx)(v.a,{fullWidth:!0,variant:"contained",color:"primary",disabled:U.inProgress||t.status!==i.Pending,onClick:function(){U.inProgress=!0,U.appointments.callEntity(t.entityKey,"respond",!0).catch((function(t){return alert(t.message)})).finally((function(){U.inProgress=!1}))},children:"Accept"})}),Object(M.jsx)(C.a,{item:!0,xs:1,children:Object(M.jsx)(v.a,{fullWidth:!0,variant:"contained",color:"secondary",disabled:U.inProgress||t.status!==i.Pending,onClick:function(){U.inProgress=!0,U.appointments.callEntity(t.entityKey,"respond",!1).catch((function(t){return alert(t.message)})).finally((function(){U.inProgress=!1}))},children:"Decline"})}),Object(M.jsx)(C.a,{item:!0,xs:1,children:Object(M.jsx)(v.a,{fullWidth:!0,variant:"contained",color:"default",disabled:U.inProgress||t.status===i.Pending,onClick:function(){U.inProgress=!0,U.appointments.callEntity(t.entityKey,"delete").catch((function(t){return alert(t.message)})).finally((function(){U.inProgress=!1}))},children:"Delete"})})]})})})}))]})]})}}]),n}(s.a.Component));r.a.render(Object(M.jsx)(_,{}),document.getElementById("root"))}},[[93,1,2]]]);
//# sourceMappingURL=main.5021e27a.chunk.js.map